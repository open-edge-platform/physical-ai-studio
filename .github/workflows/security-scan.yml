# Security scan workflow for the Geti project

# This workflow is triggered on schedule, workflow_dispatch, and pushes to develop and release branches.
# It performs comprehensive security scanning using multiple tools to identify vulnerabilities,
# secrets, configuration issues, and code quality problems across the entire codebase.
# It also scans GitHub Actions workflows for potential security issues.

# Key Features:
# - Scans GitHub Actions workflows for security vulnerabilities (Zizmor)
# - Performs static security analysis of Python code (Bandit)
# - Scans for vulnerabilities, secrets, and misconfigurations (Trivy)
# - Conducts semantic code analysis for security issues (Semgrep)

# Process Stages:
# 1. Scan GitHub Actions workflows with Zizmor
# 2. Analyze Python code security with Bandit
# 3. Perform filesystem security scan with Trivy
# 4. Run semantic security analysis with Semgrep

# Security Tools:
# - Zizmor: GitHub Actions workflow security scanner
# - Bandit: Python security linter
# - Trivy: Vulnerability and misconfiguration scanner
# - Semgrep: Static analysis tool for finding bugs and security issues

name: "Security scan"

on:
  schedule:
    # Run security checks every day at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
  push:
    branches:
      - main
      - releases/**
  pull_request:
    branches:
      - main
      - releases/**

permissions: {} # No permissions by default

jobs:
  zizmor-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - &checkout
        name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # FIXME: needed for tj-actions/changed-files to gather changed files, once repository becomes public this argument should be set to false
          persist-credentials: true

      - name: Run Zizmor scan
        uses: open-edge-platform/geti-ci/actions/zizmor@d12afacb644860a6971f0ff3dc63b460b127b6ac
        with:
          scan-scope: ${{ github.event_name == 'pull_request' && 'changed' || 'all' }}
          severity-level: ${{ github.event_name == 'pull_request' && 'MEDIUM' || 'LOW' }}
          confidence-level: ${{ github.event_name == 'pull_request' && 'MEDIUM' || 'LOW' }}
          fail-on-findings: ${{ github.event_name == 'pull_request' && 'true' || 'false' }} # reports only
          output-format: "plain" # Use plain text output format to omit uploading code scanning results to Security tab

  bandit-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - *checkout

      - name: Run Bandit scan
        uses: open-edge-platform/geti-ci/actions/bandit@d12afacb644860a6971f0ff3dc63b460b127b6ac
        with:
          scan-scope: ${{ github.event_name == 'pull_request' && 'changed' || 'all' }}
          severity-level: ${{ github.event_name == 'pull_request' && 'MEDIUM' || 'LOW' }}
          confidence-level: ${{ github.event_name == 'pull_request' && 'MEDIUM' || 'LOW' }}
          config_file: ".github/bandit_config.yml"
          fail-on-findings: ${{ github.event_name == 'pull_request' && 'true' || 'false' }} # reports only
          output-format: "txt" # Use plain text output format to omit uploading code scanning results to Security tab

  trivy-scan:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run Trivy scan
        id: trivy
        uses: open-edge-platform/geti-ci/actions/trivy@d12afacb644860a6971f0ff3dc63b460b127b6ac
        with:
          scan_type: "fs"
          scan-scope: all
          severity: "LOW"
          scanners: "vuln,secret,config"
          format: "table" # Use plain text output format to omit uploading code scanning results to Security tab
          timeout: "15m"
          ignore_unfixed: "false"

  semgrep-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Run Semgrep scan
        uses: open-edge-platform/geti-ci/actions/semgrep@d12afacb644860a6971f0ff3dc63b460b127b6ac
        with:
          scan-scope: ${{ github.event_name == 'pull_request' && 'changed' || 'all' }}
          severity: ${{ github.event_name == 'pull_request' && 'HIGH' || 'LOW' }}
          fail-on-findings: ${{ github.event_name == 'pull_request' && 'true' || 'false' }} # reports only
          output-format: "text" # Use plain text output format to omit uploading code scanning results to Security tab
